{{- $images := .Get "images" -}}
{{- $interval := .Get "interval" | default "7000" -}}
{{- $customClasses := .Get "classes" | default "" -}}
{{- $isAboveTheFold := .Get "isAboveTheFold" | default false -}}

{{- $imageList := split $images "," -}}

{{- $page := .Page -}}
{{- $smallImages := slice -}}
{{- $mediumImages := slice -}}
{{- $largeImages := slice -}}
{{- $mediumImageElements := slice -}}

{{- range $imageList }}
    {{- $img := "" -}}
    {{- if $page.Resources.GetMatch . -}}
        {{- $img = $page.Resources.GetMatch . -}}
    {{- else -}}
        {{- $img = resources.Get . -}}
    {{- end -}}

    {{- $small := $img.Resize "600x" | fingerprint -}}
    {{- $medium := $img.Resize "1200x" | fingerprint -}}
    {{- $original := $img | fingerprint -}}

    {{- $smallImages = $smallImages | append $small.RelPermalink -}}
    {{- $mediumImages = $mediumImages | append $medium.RelPermalink -}}
    {{- $largeImages = $largeImages | append $original.RelPermalink -}}

    {{- $mediumImageElements = $mediumImageElements | append $medium -}}
{{- end -}}

<link rel="preload" as="image" href="{{ (index $mediumImageElements 0).RelPermalink }}" fetchpriority="high">

<div class="image-fade-slider {{ $customClasses }}"
     data-images='{{ jsonify $mediumImages }}'
     data-small-images='{{ jsonify $smallImages }}'
     data-large-images='{{ jsonify $largeImages }}'
     data-interval='{{ $interval }}'
     style="background-image:url({{ index $mediumImages 0 }});">

    <picture>
        <source srcset="{{ index $smallImages 0 }} 600w, {{ index $mediumImages 0 }} 1200w, {{ index $largeImages 0 }} 2000w"
                sizes="(max-width: 512px) 600px, (max-width: 1024px) 1200px, 2000px"
                type="image/webp" />
        <img src="{{ (index $mediumImageElements 0).RelPermalink }}"
             class="image"
             alt="Image Slider"
             width="{{ (index $mediumImageElements 0).Width }}"
             height="{{ (index $mediumImageElements 0).Height }}"
             loading="{{ cond $isAboveTheFold "eager" "lazy" }}"
        decoding="{{ cond $isAboveTheFold "sync" "async" }}" />
    </picture>
</div>

<script>
    (function() {
        const sliders = document.querySelectorAll('.image-fade-slider');

        sliders.forEach(slider => {
            const images = JSON.parse(slider.getAttribute('data-images'));
            const smallImages = JSON.parse(slider.getAttribute('data-small-images'));
            const largeImages = JSON.parse(slider.getAttribute('data-large-images'));
            const interval = parseInt(slider.getAttribute('data-interval'), 10) || 5000;
            let index = 0;

            setInterval(() => {
                index = (index + 1) % images.length;
                slider.style.backgroundImage = `url(${images[index]})`;

                const picture = slider.querySelector('picture');
                const source = picture.querySelector('source');
                const img = picture.querySelector('img');

                if (source && img) {
                    img.classList.add('fade-out');
                    setTimeout(() => {
                        source.setAttribute('srcset', `${smallImages[index]} 600w, ${images[index]} 1200w, ${largeImages[index]} 2000w`);
                        img.setAttribute('src', smallImages[index]);
                    }, 100);

                    img.onload = () => {
                        img.classList.remove('fade-out');
                    };
                }
            }, interval);
        });
    })();
</script>
